<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>SYMAP</title>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
		<style type="text/css">
            
            svg .bg {
                pointer-events: all;
            }
            
			svg .symapFill {
                stroke: white;
                stroke-width: 4px;
                stroke-linejoin: round;
            }
            
            svg .intBoundary {
                stroke: white;
                stroke-width: 0.5px;
                stroke-dasharray: 1,1.5;
                stroke-linejoin: round;
                fill:none;
                opacity: 1;
            }
            
            svg .extBoundary {
                stroke: black;
                stroke-width: 1.5px;
                stroke-dasharray: 2,2;
                stroke-linejoin: round;
                fill:none;
                opacity: 1;
            }
            
            svg text {
                font-family: 'Courier New', Courier, 'Lucida Sans Typewriter', 'Lucida Typewriter', monospace;
                font-weight: normal;
                opacity: 0.9;
                text-anchor: middle;
		</style>
	</head>
	<body>
        
        <div id="map"></div>
        
        <script type = "text/javascript">
        
        (function() {
          var rand, umd,
            slice = [].slice;

          rand = function() {
            return ((Math.random().toString(36)) + "00000000000000000").replace(/[^a-z]+/g, "").slice(0, 5);
          };

          umd = function(factory) {
            if (typeof exports === 'object') {
              return module.exports = factory();
            } else if (typeof define === 'function' && define.amd) {
              return define([], factory);
            } else {
              return this.textures = factory();
            }
          };

            umd(function() {
                return {
                    symap: function() {
                        var background = "",
                        fontSize = 5;
                        xSize = Math.round(fontSize * 0.7);
                        ySize = Math.round(fontSize * 1.25);
                        fill = "#000000";
                        opacity = 0.85;
                        id = rand();
                        text = ["O","X","A","V"];
                        
                        symap = function() {
                            var corner, g, i, len, ref, results;
                            g = this.append("defs").append("pattern").attr({
                                    id: id,
                                    patternUnits: "userSpaceOnUse",
                                    width: xSize,
                                    height: ySize * 0.65
                                });
                            if (background) {
                                g.append("rect").attr({
                                        width: xSize,
                                        height: ySize,
                                        fill: background
                                    });
                            }
                            for(var i=0; i < text.length; i++) {
                                g.append("text").attr({
                                    x: Math.round(xSize / 2),
                                    y: Math.round(ySize / 2),
                                    "font-size": fontSize,
                                    fill: fill,
                                    "fill-opacity": opacity
                                })
                                .text(text[i]);
                            }
                        };
                        symap.background = function(_) {
                            background = _;
                            return symap;
                        };
                        symap.size = function(_) {
                            size = _;
                            return symap;
                        };
                        symap.fontSize = function(_) {
                            fontSize = _;
                            return symap;
                        };
                        symap.fill = function(_) {
                            fill = _;
                            return symap;
                        };
                        symap.kerning = function(_) {
                            kerning = _;
                            return symap;
                        };
                        symap.text = function(_) {
                            text = _;
                            return symap;
                        };
                        symap.id = function(_) {
                            if (!arguments.length) {
                                return id;
                            } else {
                                id = _;
                                return circles;
                            }
                        };
                    symap.url = function() {
                        return "url(#" + id + ")";
                    };
                    return symap;
                    }
                };
            });

            }).call(this);
        </script>
        
		<script type="text/javascript">
            
            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            var w = 1200 - margin.right - margin.left;
            var h = 600 - margin.top - margin.bottom;
            
            var panBuffer = 100;

            //GEO-SETUP!

            //Define projection.
            var projection = d3.geo.conicEqualArea()
                .rotate([85.76394, 0])
                .center([0,37.81914])
                .parallels([36,40])
                .scale(9000)
                .translate([w / 2, h / 2]);

            //Define path generator.     
            var path = d3.geo.path()
                .projection(projection);
            
            var zoom = d3.behavior.zoom()
                        .translate([0, 0])
                        .scale(1)
                        .scaleExtent([1, 3])
                        .size([w + panBuffer,h + panBuffer])
                        .on("zoom", zoomed);

            //Build map frame.
			var svg = d3.select("#map")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
            
            var features = svg.append("g");

            //Set background pattern.
            var t = textures.symap()
              .text("-");

            svg.call(t);

            features.append("rect")
                    .attr("class", "bg")
                    .style("fill", t.url())
                    .attr("width", w)
                    .attr("height", h)
                    .attr("opacity",0.4)
                    .call(zoom);
                
            var symbology = [["-"],["<",">"],["*"],["#"],[">","<"],["O","X"],["M","W"],["O","M","W"],["O","X","A","V"]];
            
            d3.json('kyCountyPops.json', function(error, ky) {
                
                if (error) return console.error(error);
                
                svg.call(zoom);
                
                var counties = topojson.feature(ky, ky.objects.counties).features;
                
                var pop = [];
                for (var i = 0; i < counties.length; i++) {
                    pop[i] = counties[i].properties.population;
                }
            
                var shade = d3.scale.quantize()
                    .domain(d3.extent(pop))
                    .range(symbology);
            
    
                features.attr("class","symapFill")
                    .selectAll("path")
                    .data(topojson.feature(ky, ky.objects.counties).features)
                    .enter()
                    .append("path")
                    .style("fill", function(d,i) {
                        var val = shade(pop[i]);

                        if (val !== undefined) {

                            var t = textures.symap()
                                .text(val)
                                .background("white");

                            svg.call(t);
                            return t.url();
                        }
                    })
                    .attr("d", path);
                
                features.append("path")
                    .datum(topojson.mesh(ky, ky.objects.counties, function(a, b) { return a !== b; }))
                    .attr("class","intBoundary")
                    .attr("d", path);
                
                features.append("path")
                    .datum(topojson.mesh(ky, ky.objects.counties, function(a, b) { return a === b; }))
                    .attr("class","extBoundary")
                    .attr("d", path);
            });
            
            function zoomed() {
                var e = d3.event;
                var tx = Math.min(0, Math.max(e.translate[0], w - (w * e.scale)));
                var ty = Math.min(0, Math.max(e.translate[1], h - (h * e.scale)));
                
                zoom.translate([tx, ty]);
                
                features.attr("transform", "translate(" + [tx, ty] + ")scale(" + e.scale + ")");
            }
			
		</script>
	</body>
</html>